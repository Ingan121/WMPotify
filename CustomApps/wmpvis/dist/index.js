var wmpvis=(()=>{var e,t,a=Object.create,n=Object.defineProperty,o=Object.getOwnPropertyDescriptor,i=Object.getOwnPropertyNames,l=Object.getPrototypeOf,s=Object.prototype.hasOwnProperty,c=(t,r,a,l)=>{if(r&&"object"==typeof r||"function"==typeof r)for(let e of i(r))s.call(t,e)||e===a||n(t,e,{get:()=>r[e],enumerable:!(l=o(r,e))||l.enumerable});return t},r=(e,t,r)=>(r=null!=e?a(l(e)):{},c(!t&&e&&e.__esModule?r:n(r,"default",{value:e,enumerable:!0}),e)),h=(e={"external-global-plugin:react"(e,t){t.exports=Spicetify.React}},function(){return t||(0,e[i(e)[0]])((t={exports:{}}).exports,t),t.exports}),u={},d=(((e,t)=>{for(var r in t)n(e,r,{get:t[r],enumerable:!0})})(u,{default:()=>function(){return D.default.createElement(V,null)}}),r(h()));function k(e){return Math.min(Math.max(Math.pow(10,e/20),0),1)}function _(e,t,r){let a=0,l=e.length;for(;1<l-a;){var n=Math.floor((l+a)/2);t(e[n],n)<=r?a=n:l=n}return a}function P(e){return e*e*(3-2*e)}async function f(){var e=await Spicetify.getAudioData(),o=e.segments,i=(e=>{e=e.replace(/-/g,"+").replace(/_/g,"/");var e=new Uint8Array(atob(e).split("").map(e=>e.charCodeAt(0))),e=window.fflate.unzlibSync(e),t=(new TextDecoder).decode(e).split(" ").map(e=>parseInt(e)),r=[];if(!(t.length<3)){var e=t.shift(),a=t.shift()/e,l=t.shift();if(!(t.length<l))for(let e=0;e<l;e++){var n=[],o=t.shift();if(t.length<o+(l-e-1))return r;for(let e=0;e<o;e++){var i=t.shift()*a;n.push(0==e?i:n[e-1]+i)}r.push(n)}}return r})(e.track.rhythmstring);if(0===o.length||0===i.length)return[];var s,c,h,u,d,f,p,g,m=.4/Math.sqrt(2)*8,v=12*i.length,w=[];for(let e=0;e<o.length;e++){var y=o[e];let t=k(y.loudness_start),r=k(y.loudness_max),a=y.start+y.loudness_max_time;var b=y.pitches;let l=a-m,n=a+m;var S=i.map(e=>{var t=_(e,e=>e,l),r=_(e,e=>e,n);return e.slice(t,r).map(e=>Math.exp(-Math.pow((e-a)/.4,2))).reduce((e,t)=>e+t,0)+.2}),M=Math.max(...S);for(let e=0;e<S.length;e++)S[e]/=M;var R=Array(v);for(let t=0;t<S.length;t++){f=t,p=0,g=S.length-1;var x=f=(f=(f-p)/(g-p))*(.6-(g=.2))+g;for(let e=0;e<12;e++){A=[...S.entries()],s=e=>e[0],c=e=>e[1],O=P,h=t+e/12,d=C=u=void 0,C=_(A,s,h),d=A[C];var A=A.length-2<C?c(d,C):(A=A[C+1],h=h,u=s(d,C),s=s(A,C+1),O=O,d=c(d,C),c=c(A,C+1),h=(h=O(h=(h-u)/(s-u)))*(c-d)+d),C=b.reduce((e,t)=>e+t,0)/b.length,O=b[e]*x+C*(1-x);R[12*t+e]=A*O}}if(w.push([y.start,...R.map(e=>e*t)]),w.push([a,...R.map(e=>e*r)]),e==o.length-1){let t=k(y.loudness_end);w.push([y.start+y.duration,...R.map(e=>e*t)])}}return w}var p,g=null,m=null,v=null,w=null,y=null,b=null,S=!1,M={},R=96,x=30,A=new Array(R).fill(0),C=new Array(R).fill(0),O=new Array(R).fill(0),E=new Array(R).fill(0),I=0;async function j(){if(g&&m&&y){var a=(e=>{if(!b)return-1;var t=Spicetify.Player.getProgress()/1e3;let r=e;for(r<0?r=0:r>=b.length&&(r=b.length-1),t<b[r][0]&&(r=0);r<b.length-1&&b[r+1][0]<t;)r++;return y.innerText=r})(I);let e=b[a]?.slice(1)||new Array(R).fill(0);if(a===I&&(e=new Array(R).fill(0)),I=a,S){if(e[Math.round(Math.random()*(R-1))]<=1e-4)return;S=!1}v.clearRect(0,0,g.width,g.height);var l=M.barWidth||Math.max(Math.round(1/R*g.width),6);v.fillStyle=M.barColor,w.fillStyle=M.topColor,M.followAlbumArt;let t=0,r=(l*R<g.width&&(t=Math.round((g.width-l*R)/2)),!0);for(var n=0;n<e.length&&(64!==n||3!==M.channelSeparation);++n){var o=Math.round(g.height*Math.min(e[n],1)*M.primaryScale),o=(o>C[n]?(C[n]=o,v.fillRect(t+l*n,g.height-o,l-1,o)):(C[n]-=M.decSpeed,.1<(o=e[n]-A[n])&&(C[n]+=Math.round(360*o*M.diffScale),C[n]>g.height)&&(C[n]=g.height),v.fillRect(t+l*n,g.height-C[n],l-1,C[n])),m.height-Math.round(C[n])-1);o<O[n]?(O[n]=o,w.fillRect(t+l*n,o,l-1,1),E[n]=0,r=!1):O[n]<m.height-1&&(w.clearRect(t+l*n,0,l-1,m.height),38<E[n]?O[n]+=5*Math.round(M.decSpeed/3):26<E[n]?(O[n]+=4*Math.round(M.decSpeed/3),E[n]+=1):18<E[n]?(O[n]+=3*Math.round(M.decSpeed/3),E[n]+=1):10<E[n]?(O[n]+=2*Math.round(M.decSpeed/3),E[n]+=1):E[n]+=1+Math.round(M.decSpeed/3),w.fillRect(t+l*n,O[n],l-1,1),r=!1),A[n]=e[n]}r&&(S=!0)}else p&&clearInterval(p)}function B(){var e=g.getBoundingClientRect();g.height=e.height,g.width=e.width,m.height=g.height,m.width=g.width,S=!1}async function T(e){g=e.visBar.current,m=e.visTop.current,y=e.debug.current,v=g.getContext("2d"),w=m.getContext("2d"),B(),O.fill(m.height),(async()=>{console.log("Setting up listeners"),b=await f(),Spicetify.Player.addEventListener("songchange",async()=>{b=await f(),I=0}),p&&clearInterval(p),p=setInterval(j,1e3/x)})(),M={barColor:localStorage.wmpotifyVisBarColor||"#a4eb0c",topColor:localStorage.wmpotifyVisTopColor||"#dfeaf7",useSchemeColors:localStorage.wmpotifyVisUseSchemeColors,followAlbumArt:localStorage.wmpotifyVisFollowAlbumArt,barWidth:8,decSpeed:parseFloat(localStorage.wmpotifyVisDecSpeed||3),primaryScale:parseFloat(localStorage.wmpotifyVisPrimaryScale||1),diffScale:parseFloat(localStorage.wmpotifyVisDiffScale||.07)},w.clearRect(0,0,m.width,m.height),S=!1,new ResizeObserver(B).observe(g)}window.addEventListener("resize",B);var V=class extends d.default.Component{constructor(e){super(e),this.elemRefs={visBar:d.default.createRef(),visTop:d.default.createRef(),debug:d.default.createRef()}}componentDidMount(){let t=new IntersectionObserver(e=>{e[0].isIntersecting&&(T(this.elemRefs),t.disconnect())});t.observe(this.elemRefs.visBar.current)}render(){return d.default.createElement(d.default.Fragment,null,d.default.createElement("section",{className:"contentSpacing"},d.default.createElement("canvas",{className:"wmpvis-visBar",style:{width:"100%",height:"100%",position:"absolute",top:0,left:0,zIndex:2},ref:this.elemRefs.visBar}),d.default.createElement("canvas",{className:"wmpvis-visTop",style:{width:"100%",height:"100%",position:"absolute",backgroundColor:"black",top:0,left:0,zIndex:1},ref:this.elemRefs.visTop}),d.default.createElement("p",{className:"wmpvis-debug",style:{position:"absolute",top:0,left:0},ref:this.elemRefs.debug})))}},D=r(h());return r=u,c(n({},"__esModule",{value:!0}),r)})();let render=()=>wmpvis.default();