var wmpvis=(()=>{function e(e,t){for(var r=new d(31),a=0;a<31;++a)r[a]=t+=1<<e[a-1];for(var n=new j(r[30]),a=1;a<30;++a)for(var l=r[a];l<r[a+1];++l)n[l]=l-r[a]<<5|a;return{b:r,r:n}}var t,r,a,E=Object.create,l=Object.defineProperty,I=Object.getOwnPropertyDescriptor,i=Object.getOwnPropertyNames,_=Object.getPrototypeOf,P=Object.prototype.hasOwnProperty,z=(t,r,a,n)=>{if(r&&"object"==typeof r||"function"==typeof r)for(let e of i(r))P.call(t,e)||e===a||l(t,e,{get:()=>r[e],enumerable:!(n=I(r,e))||n.enumerable});return t},B=(e,t,r)=>(r=null!=e?E(_(e)):{},z(!t&&e&&e.__esModule?r:l(r,"default",{value:e,enumerable:!0}),e)),D=(t={"external-global-plugin:react"(e,t){t.exports=Spicetify.React}},function(){return r||(0,t[i(t)[0]])((r={exports:{}}).exports,r),r.exports}),V={},n=(((e,t)=>{for(var r in t)l(e,r,{get:t[r],enumerable:!0})})(V,{default:()=>function(){return de.default.createElement(he,null)}}),B(D())),q=Uint8Array,d=Uint16Array,j=Int32Array,X=new q([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Y=new q([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Z=new q([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),o=e(X,2),$=o.b,o=(o.r[$[28]=258]=28,e(Y,0)),ee=o.b,p=new d(32768);for(s=0;s<32768;++s)p[s]=((65280&(a=(61680&(a=(52428&(a=(43690&s)>>1|(21845&s)<<1))>>2|(13107&a)<<2))>>4|(3855&a)<<4))>>8|(255&a)<<8)>>1;var G=function(e,t,r){for(var a=e.length,n=0,l=new d(t);n<a;++n)e[n]&&++l[e[n]-1];var i=new d(t);for(n=1;n<t;++n)i[n]=i[n-1]+l[n-1]<<1;if(r){for(var o=new d(1<<t),f=15-t,n=0;n<a;++n)if(e[n])for(var s=n<<4|e[n],c=t-e[n],u=i[e[n]-1]++<<c,h=u|(1<<c)-1;u<=h;++u)o[p[u]>>f]=s}else for(o=new d(a),n=0;n<a;++n)e[n]&&(o[n]=p[i[e[n]-1]++]>>15-e[n]);return o},f=new q(288);for(s=0;s<144;++s)f[s]=8;for(s=144;s<256;++s)f[s]=9;for(s=256;s<280;++s)f[s]=7;for(s=280;s<288;++s)f[s]=8;var s,F=new q(32);for(s=0;s<32;++s)F[s]=5;var te=G(f,9,1),re=G(F,5,1),H=function(e){for(var t=e[0],r=1;r<e.length;++r)t<e[r]&&(t=e[r]);return t},J=function(e,t,r){var a=t/8|0;return(e[a]|e[1+a]<<8)>>(7&t)&r},K=function(e,t){var r=t/8|0;return(e[r]|e[1+r]<<8|e[2+r]<<16)>>(7&t)},ae=function(e){return(e+7)/8|0},ne=function(e,t,r){return(null==r||r>e.length)&&(r=e.length),new q(e.subarray(t=null==t||t<0?0:t,r))},N=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],Q=function(e,t,r){t=new Error(t||N[e]);if(t.code=e,Error.captureStackTrace&&Error.captureStackTrace(t,Q),r)return t;throw t},U=function(e,t,r,a){var n=e.length,D=a?a.length:0;if(!n||t.f&&!t.l)return r||new q(0);function l(e){var t=r.length;t<e&&((t=new q(Math.max(2*t,e))).set(r),r=t)}var i=!r,o=i||2!=t.i,f=t.i,s=(i&&(r=new q(3*n)),t.f||0),c=t.p||0,u=t.b||0,h=t.l,d=t.d,p=t.m,v=t.n,g=8*n;do{if(!h){var s=J(e,c,1),m=J(e,c+1,3);if(c+=3,!m){var w=e[(R=ae(c)+4)-4]|e[R-3]<<8,y=R+w;if(n<y){f&&Q(0);break}o&&l(u+w),r.set(e.subarray(R,y),u),t.b=u+=w,t.p=c=8*y,t.f=s;continue}if(1==m)h=te,d=re,p=9,v=5;else if(2==m){for(var w=J(e,c,31)+257,b=J(e,c+10,15)+4,S=w+J(e,c+5,31)+1,M=(c+=14,new q(S)),x=new q(19),A=0;A<b;++A)x[Z[A]]=J(e,c+3*A,7);c+=3*b;for(var y=H(x),V=(1<<y)-1,j=G(x,y,1),A=0;A<S;){var R,C=j[J(e,c,V)];if(c+=15&C,(R=C>>4)<16)M[A++]=R;else{var O=0,T=0;for(16==R?(T=3+J(e,c,3),c+=2,O=M[A-1]):17==R?(T=3+J(e,c,7),c+=3):18==R&&(T=11+J(e,c,127),c+=7);T--;)M[A++]=O}}var k=M.subarray(0,w),E=M.subarray(w),p=H(k),v=H(E),h=G(k,p,1),d=G(E,v,1)}else Q(1);if(g<c){f&&Q(0);break}}o&&l(u+131072);for(var F=(1<<p)-1,N=(1<<v)-1,I=c;;I=c){var _=(O=h[K(e,c)&F])>>4;if(g<(c+=15&O)){f&&Q(0);break}if(O||Q(2),_<256)r[u++]=_;else{if(256==_){I=c,h=null;break}var P,z=_-254,_=(264<_&&(P=X[A=_-257],z=J(e,c,(1<<P)-1)+$[A],c+=P),d[K(e,c)&N]),B=_>>4,E=(_||Q(3),c+=15&_,ee[B]);if(3<B&&(P=Y[B],E+=K(e,c)&(1<<P)-1,c+=P),g<c){f&&Q(0);break}o&&l(u+131072);var U=u+z;if(u<E){var W=D-E,L=Math.min(E,U);for(W+u<0&&Q(3);u<L;++u)r[u]=a[W+u]}for(;u<U;++u)r[u]=r[u-E]}}t.l=h,t.p=I,t.b=u,t.f=s,h&&(s=1,t.m=p,t.d=d,t.n=v)}while(!s);return u!=r.length&&i?ne(r,0,u):r.subarray(0,u)},o=new q(0),W=function(e,t){return(8!=(15&e[0])||7<e[0]>>4||(e[0]<<8|e[1])%31)&&Q(6,"invalid zlib data"),(e[1]>>5&1)==+!t&&Q(6,"invalid zlib data: "+(32&e[1]?"need":"unexpected")+" dictionary"),2+(e[1]>>3&4)};var c="undefined"!=typeof TextDecoder&&new TextDecoder;try{c.decode(o,{stream:!0})}catch(e){}function L(e){e=e.replace(/-/g,"+").replace(/_/g,"/");var e=new Uint8Array(atob(e).split("").map(e=>e.charCodeAt(0))),e=U(e.subarray(W(e,a&&a.dictionary),-4),{i:2},a&&a.out,a&&a.dictionary),t=(new TextDecoder).decode(e).split(" ").map(e=>parseInt(e)),r=[];if(!(t.length<3)){var a=t.shift(),n=t.shift()/a,l=t.shift();if(!(t.length<l))for(let e=0;e<l;e++){var i=[],o=t.shift();if(t.length<o+(l-e-1))return r;for(let e=0;e<o;e++){var f=t.shift()*n;i.push(0==e?f:i[e-1]+f)}r.push(i)}}return r}function T(e){return Math.min(Math.max(Math.pow(10,e/20),0),1)}function k(e,t,r){let a=0,n=e.length;for(;1<n-a;){var l=Math.floor((n+a)/2);t(e[l],l)<=r?a=l:n=l}return a}function le(e){return e*e*(3-2*e)}async function ie(){var e=await Spicetify.getAudioData(),i=e.segments,o=L(e.track.rhythmstring);if(0===i.length||0===o.length)return[];var f,s,c,u,h,d,p,v,g=.4/Math.sqrt(2)*8,m=12*o.length,w=[];for(let e=0;e<i.length;e++){var y=i[e];let t=T(y.loudness_start),r=T(y.loudness_max),a=y.start+y.loudness_max_time;var b=y.pitches;let n=a-g,l=a+g;var S=o.map(e=>{var t=k(e,e=>e,n),r=k(e,e=>e,l);return e.slice(t,r).map(e=>Math.exp(-Math.pow((e-a)/.4,2))).reduce((e,t)=>e+t,0)+.2}),M=Math.max(...S);for(let e=0;e<S.length;e++)S[e]/=M;var x=Array(m);for(let t=0;t<S.length;t++){d=t,p=0,v=S.length-1;var A=d=(d=(d-p)/(v-p))*(.6-(v=.2))+v;for(let e=0;e<12;e++){R=[...S.entries()],f=e=>e[0],s=e=>e[1],O=le,c=t+e/12,h=C=u=void 0,C=k(R,f,c),h=R[C];var R=R.length-2<C?s(h,C):(R=R[C+1],c=c,u=f(h,C),f=f(R,C+1),O=O,h=s(h,C),s=s(R,C+1),c=(c=O(c=(c-u)/(f-u)))*(s-h)+h),C=b.reduce((e,t)=>e+t,0)/b.length,O=b[e]*A+C*(1-A);x[12*t+e]=R*O}}if(w.push([y.start,...x.map(e=>e*t)]),w.push([a,...x.map(e=>e*r)]),e==i.length-1){let t=T(y.loudness_end);w.push([y.start+y.duration,...x.map(e=>e*t)])}}return w}var u,h=null,v=null,g=null,m=null,w=null,y=null,b=!1,S={},M=96,oe=30,fe=new Array(M).fill(0),x=new Array(M).fill(0),A=new Array(M).fill(0),R=new Array(M).fill(0),C=0;async function se(){if(h&&v&&w){var a=(e=>{if(!y)return-1;var t=Spicetify.Player.getProgress()/1e3;let r=e;for(r<0?r=0:r>=y.length&&(r=y.length-1),t<y[r][0]&&(r=0);r<y.length-1&&y[r+1][0]<t;)r++;return w.innerText=r})(C);let e=y[a]?.slice(1)||new Array(M).fill(0);if(a===C&&(e=new Array(M).fill(0)),C=a,b){if(e[Math.round(Math.random()*(M-1))]<=1e-4)return;b=!1}g.clearRect(0,0,h.width,h.height);var n=S.barWidth||Math.max(Math.round(1/M*h.width),6);g.fillStyle=S.barColor,m.fillStyle=S.topColor,S.followAlbumArt;let t=0,r=(n*M<h.width&&(t=Math.round((h.width-n*M)/2)),!0);for(var l=0;l<e.length&&(64!==l||3!==S.channelSeparation);++l){var i=Math.round(h.height*Math.min(e[l],1)*S.primaryScale),i=(i>x[l]?(x[l]=i,g.fillRect(t+n*l,h.height-i,n-1,i)):(x[l]-=S.decSpeed,.1<(i=e[l]-fe[l])&&(x[l]+=Math.round(360*i*S.diffScale),x[l]>h.height)&&(x[l]=h.height),g.fillRect(t+n*l,h.height-x[l],n-1,x[l])),v.height-Math.round(x[l])-1);i<A[l]?(A[l]=i,m.fillRect(t+n*l,i,n-1,1),R[l]=0,r=!1):A[l]<v.height-1&&(m.clearRect(t+n*l,0,n-1,v.height),38<R[l]?A[l]+=5*Math.round(S.decSpeed/3):26<R[l]?(A[l]+=4*Math.round(S.decSpeed/3),R[l]+=1):18<R[l]?(A[l]+=3*Math.round(S.decSpeed/3),R[l]+=1):10<R[l]?(A[l]+=2*Math.round(S.decSpeed/3),R[l]+=1):R[l]+=1+Math.round(S.decSpeed/3),m.fillRect(t+n*l,A[l],n-1,1),r=!1),fe[l]=e[l]}r&&(b=!0)}else u&&clearInterval(u)}function O(){var e=h.getBoundingClientRect();h.height=e.height,h.width=e.width,v.height=h.height,v.width=h.width,b=!1}async function ce(){console.log("Setting up listeners");try{y=await ie()}catch{return void setTimeout(ce,1e3)}Spicetify.Player.addEventListener("songchange",async()=>{y=await ie(),C=0}),u&&clearInterval(u),u=setInterval(se,1e3/oe)}async function ue(e){h=e.visBar.current,v=e.visTop.current,w=e.debug.current,g=h.getContext("2d"),m=v.getContext("2d"),O(),A.fill(v.height),ce(),S={barColor:localStorage.wmpotifyVisBarColor||"#a4eb0c",topColor:localStorage.wmpotifyVisTopColor||"#dfeaf7",useSchemeColors:localStorage.wmpotifyVisUseSchemeColors,followAlbumArt:localStorage.wmpotifyVisFollowAlbumArt,barWidth:parseInt(localStorage.wmpotifyVisBarWidth||8),decSpeed:parseFloat(localStorage.wmpotifyVisDecSpeed||3),primaryScale:parseFloat(localStorage.wmpotifyVisPrimaryScale||1),diffScale:parseFloat(localStorage.wmpotifyVisDiffScale||.07)},m.clearRect(0,0,v.width,v.height),b=!1,new ResizeObserver(O).observe(h)}window.addEventListener("resize",O);var he=class extends n.default.Component{constructor(e){super(e),this.elemRefs={visBar:n.default.createRef(),visTop:n.default.createRef(),debug:n.default.createRef()}}componentDidMount(){let t=new IntersectionObserver(e=>{e[0].isIntersecting&&(ue(this.elemRefs),t.disconnect())});t.observe(this.elemRefs.visBar.current)}render(){return n.default.createElement(n.default.Fragment,null,n.default.createElement("section",{className:"contentSpacing"},n.default.createElement("canvas",{className:"wmpvis-visBar",style:{width:"100%",height:"100%",position:"absolute",top:0,left:0,zIndex:2},ref:this.elemRefs.visBar}),n.default.createElement("canvas",{className:"wmpvis-visTop",style:{width:"100%",height:"100%",position:"absolute",backgroundColor:"black",top:0,left:0,zIndex:1},ref:this.elemRefs.visTop}),n.default.createElement("p",{className:"wmpvis-debug",style:{position:"absolute",top:0,left:0,zIndex:3},ref:this.elemRefs.debug})))}},de=B(D());return c=V,z(l({},"__esModule",{value:!0}),c)})();let render=()=>wmpvis.default();