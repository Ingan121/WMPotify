(()=>{var S=class{constructor(a=[],n=[]){this.menuOrder=a,this.submenus=n,this.openedMenu=null,this.mouseOverMenu=!1,this.mouseOverSubmenu=!1,this.handlingPointerEvent=!1,this.handlingKeyEvent=!1,this.boundMenuNavigationHandler=this.menuNavigationHandler.bind(this),this.submenuOpenTimer=null,this.submenuCloseTimer=null,this.shouldNotCloseSubmenu=!1,this.menuHierarchy={},this.beforeMenuOpenEvent=new Event("beforemenuopen"),this.afterMenuCloseEvent=new Event("aftermenuclose");for(let e of a){this.menuHierarchy[e]=[];let t=document.getElementById(e+"MenuBg"),i=t.querySelectorAll(".contextMenuItem");for(let o of i)o.dataset.submenu&&this.menuHierarchy[e].push(o.dataset.submenu),o.addEventListener("pointerover",()=>{for(let r of i)delete r.dataset.active;o.dataset.active=!0,clearTimeout(this.submenuOpenTimer),o.dataset.submenu?this.submenuOpenTimer=setTimeout(()=>{this.openMenu(o.dataset.submenu)},300):this.menuHierarchy[e].length>0&&this.delayedCloseMenu(this.menuHierarchy[e][0])}),o.addEventListener("pointerleave",()=>{this.mouseOverSubmenu||(delete o.dataset.active,clearTimeout(this.submenuOpenTimer),o.dataset.submenu&&this.delayedCloseMenu(o.dataset.submenu))}),o.addEventListener("click",()=>{o.dataset.submenu&&!o.classList.contains("disabled")?this.openedMenu.id!==o.dataset.submenu+"MenuBg"?this.openMenu(o.dataset.submenu):document.getElementById(o.dataset.submenu+"MenuBg").focus():o.dataset.noClose||this.closeMenu(e)});t.addEventListener("focusout",o=>{top.ignoreFocusLoss||o.relatedTarget&&o.relatedTarget.dataset.submenuOf===e||this.closeMenu(e)}),t.addEventListener("pointermove",o=>{(o.clientX>0||o.clientY>0)&&(t.style.animation="none")})}for(let e of n){let t=document.getElementById(e+"MenuBg"),i=t.querySelectorAll(".contextMenuItem"),o=document.getElementById(t.dataset.submenuOf+"MenuBg"),r=Array.from(o.querySelectorAll(".contextMenuItem")).findIndex(c=>c.dataset.submenu===e),u=o.querySelectorAll(".contextMenuItem")[r];for(let c of i)c.addEventListener("pointerover",()=>{for(let f of i)delete f.dataset.active;c.dataset.active=!0}),c.addEventListener("pointerleave",()=>{delete c.dataset.active}),c.addEventListener("click",()=>{this.shouldNotCloseSubmenu=!1,this.closeMenu(e),this.closeMenu(t.dataset.submenuOf)});t.addEventListener("pointerover",()=>{this.mouseOverMenu=!0,this.mouseOverSubmenu=!0,this.shouldNotCloseSubmenu=!0,clearTimeout(this.submenuCloseTimer),u.dataset.active=!0}),t.addEventListener("pointerleave",()=>{this.mouseOverMenu=!1,this.mouseOverSubmenu=!1,this.shouldNotCloseSubmenu=!1}),t.addEventListener("focusout",c=>{if(top.ignoreFocusLoss||t.style.display==="none")return;this.shouldNotCloseSubmenu=!1;let f=!!t.dataset.openStandalone;c.relatedTarget&&c.relatedTarget.id&&c.relatedTarget.id===o.id||(this.closeMenu(e),!(c.relatedTarget&&c.relatedTarget.id&&c.relatedTarget.dataset.submenuOf===t.dataset.submenuOf)&&(f||this.closeMenu(t.dataset.submenuOf)))})}}openMenu(a,n){let e=document.getElementById(a+"MenuBg"),t=document.getElementById(a+"Menu"),i=!!e.dataset.submenuOf,o,r,u,c=e.querySelectorAll(".contextMenuItem.debug");if(localStorage.wmpotifyDebugMode){u=e.querySelectorAll(".contextMenuItem:not([data-hidden])");for(let d of c)d.style.display=""}else{u=e.querySelectorAll(".contextMenuItem:not([data-hidden]):not(.debug)");for(let d of c)d.style.display="none"}if(e.dispatchEvent(this.beforeMenuOpenEvent),n)e.dataset.openStandalone=!0;else{if(i){if(this.menuHierarchy[e.dataset.submenuOf].length>1)for(let y of this.menuHierarchy[e.dataset.submenuOf])y!==a&&this.closeMenu(y);if(o=document.getElementById(e.dataset.submenuOf+"MenuBg"),o.style.display==="none")return;let d=Array.from(o.querySelectorAll(".contextMenuItem")).findIndex(y=>y.dataset.submenu===a);if(r=o.querySelectorAll(".contextMenuItem")[d],r.classList.contains("disabled"))return}else for(let d of this.menuOrder)d!==a&&document.getElementById(d+"MenuBg").style.display==="block"&&this.closeMenu(d);delete e.dataset.openStandalone}e.style.animation="";for(let d of u)delete d.dataset.active;if(n)n.top&&(e.style.top=n.top),n.left&&(e.style.left=n.left),n.right&&(e.style.right=n.right),n.bottom&&(e.style.bottom=n.bottom);else{let d="",y=0;i&&(d=o.offsetTop+r.offsetTop,y=o.offsetLeft+o.offsetWidth-6),e.style.top=d+"px",e.style.left=y+"px"}e.style.display="block";let f=this.calcMenuWidth(a);e.style.width=f+")",e.style.minWidth=0,t.style.width=f+" - 2px)",e.style.height=this.calcMenuHeight(a)+"px",n||i&&(r.dataset.active=!0),e.focus(),this.openedMenu=e,document.addEventListener("keydown",this.boundMenuNavigationHandler)}closeMenu(a){let n=document.getElementById(a+"MenuBg"),e=!!n.dataset.openStandalone,t=!!n.dataset.submenuOf&&!e;if(t&&this.shouldNotCloseSubmenu)return;let i,o;if(!e&&t){i=document.getElementById(n.dataset.submenuOf+"MenuBg");let r=Array.from(i.querySelectorAll(".contextMenuItem")).findIndex(u=>u.dataset.submenu===a);o=i.querySelectorAll(".contextMenuItem")[r]}this.submenuCloseTimer&&clearTimeout(this.submenuCloseTimer),n.style.display="none",e?delete n.dataset.openStandalone:t&&delete o.dataset.active,n.dispatchEvent(this.afterMenuCloseEvent),t&&i.style.display!=="none"?(i.focus(),this.openedMenu=i):(this.openedMenu=null,document.removeEventListener("keydown",this.boundMenuNavigationHandler))}delayedCloseMenu(a){this.submenuCloseTimer=setTimeout(()=>{this.closeMenu(a)},300)}menuNavigationHandler(a){if(!this.openedMenu)return;let n;localStorage.wmpotifyDebugMode?n=this.openedMenu.querySelectorAll(".contextMenuItem"):n=this.openedMenu.querySelectorAll(".contextMenuItem:not(.debug)");let e=this.openedMenu.querySelector(".contextMenuItem[data-active]"),t=Array.from(n).indexOf(e),i;switch(this.openedMenu.dataset.submenuOf&&(i=document.getElementById(this.openedMenu.dataset.submenuOf+"MenuBg").querySelector(".contextMenuItem[data-active]")),this.handlingKeyEvent=!0,this.openedMenu.style.animation="none",a.key){case"Escape":this.mouseOverMenu=!1,this.openedMenu.blur();break;case"ArrowUp":e?(delete e.dataset.active,t>0?n[t-1].dataset.active=!0:n[n.length-1].dataset.active=!0):n[n.length-1].dataset.active=!0;break;case"ArrowDown":e?(delete e.dataset.active,t<n.length-1?n[t+1].dataset.active=!0:n[0].dataset.active=!0):n[0].dataset.active=!0;break;case"ArrowLeft":if(this.openedMenu.dataset.submenuOf){this.closeMenu(this.openedMenu.id.slice(0,-6),!0),i.dataset.active=!0;break}if(this.menuOrder.length===1)break;let o=this.menuOrder[(this.menuOrder.indexOf(this.openedMenu.id.slice(0,-6))+this.menuOrder.length-1)%this.menuOrder.length];this.closeMenu(this.openedMenu.id.slice(0,-6)),this.openMenu(o),this.openedMenu.querySelector(".contextMenuItem").dataset.active=!0;break;case"ArrowRight":if(e&&e.dataset.submenu){this.openMenu(e.dataset.submenu),this.openedMenu.querySelector(".contextMenuItem").dataset.active=!0;break}if(this.menuOrder.length===1)break;let r;this.openedMenu.dataset.submenuOf?(r=this.menuOrder[(this.menuOrder.indexOf(this.openedMenu.dataset.submenuOf)+1)%this.menuOrder.length],this.closeMenu(this.openedMenu.id.slice(0,-6))):(r=this.menuOrder[(this.menuOrder.indexOf(this.openedMenu.id.slice(0,-6))+1)%this.menuOrder.length],this.closeMenu(this.openedMenu.id.slice(0,-6))),this.openMenu(r),this.openedMenu.querySelector(".contextMenuItem").dataset.active=!0;break;case"Enter":if(e)e.click();else{this.openedMenu.blur();break}break;default:let u=this.openedMenu.getElementsByTagName("u");for(let c of u)if(a.key===c.textContent.toLowerCase()){c.parentElement.click();break}}this.handlingKeyEvent=!1,a.preventDefault(),a.stopPropagation()}calcMenuWidth(a){let n=document.getElementById(a+"MenuBg"),e;localStorage.wmpotifyDebugMode?e=n.querySelectorAll(".contextMenuItem:not([data-hidden])"):e=n.querySelectorAll(".contextMenuItem:not([data-hidden]):not(.debug)"),n.style.minWidth="";let t=parseInt(getComputedStyle(n).minWidth)||0;return`calc(${Array.from(e).reduce((o,r)=>{let u=r.textContent,c=H(u);return Math.max(t,o,c)},0)}px + 4.5em`}calcMenuHeight(a){let n=document.getElementById(a+"MenuBg"),e=n.querySelectorAll("hr"),t;localStorage.wmpotifyDebugMode?t=n.querySelectorAll(".contextMenuItem:not([data-hidden])"):t=n.querySelectorAll(".contextMenuItem:not([data-hidden]):not(.debug)");let i=t[0].offsetHeight,o=0;if(e.length>0){let u=getComputedStyle(e[0]);o=e[0].offsetHeight+parseFloat(u.marginTop)+parseFloat(u.marginBottom)}return parseInt(t.length*i+e.length*o)}};function q(s,a,n){let e=document.createElement("div");return e.id=s+"MenuBg",e.className="contextMenuBg",e.tabIndex=-1,e.style.display="none",e.innerHTML=`<div id="${s}Menu" class="contextMenu"></div>`,n&&(e.dataset.submenuOf=n),a.forEach(t=>{if(t.hr){let o=document.createElement("hr");e.querySelector(".contextMenu").appendChild(o);return}let i=document.createElement("div");i.className="contextMenuItem",t.args?i.innerHTML="<p>"+F(t.text,...t.args)+"</p>":i.innerHTML="<p>"+F(t.text)+"</p>",t.classList&&i.classList.add(...t.classList),t.disabled&&i.classList.add("disabled"),t.hidden&&(i.dataset.hidden=!0),t.submenu&&(i.dataset.submenu=t.submenu,i.innerHTML+='<p class="submenuMark">\u23F5</p>'),t.noClose&&(i.dataset.noClose=!0),i.addEventListener("click",t.click),e.querySelector(".contextMenu").appendChild(i)}),document.body.appendChild(e),{menuBg:e,menu:e.querySelector(".contextMenu"),menuItems:e.querySelectorAll(".contextMenuItem")}}function H(s,a=getComputedStyle(document.documentElement).getPropertyValue("--menu-font")){let e=(H.canvas||(H.canvas=document.createElement("canvas"))).getContext("2d");return e.font=a,e.measureText(s).width}function F(s){if(s=s.replace(/&([^&])/g,"<u>$1</u>").replace(/\\&/g,"&"),arguments.length>1)for(let a=1;a<arguments.length;a++)s=s.replace(/%s/,arguments[a]),s=s.replace(`%${a}s`,arguments[a]);return s}function V(){let s=t=>{t&&(t._updateUiClient?.updateTitlebarHeight&&t._updateUiClient.updateTitlebarHeight({height:1}),t._updateUiClient?.setButtonsVisibility&&t._updateUiClient.setButtonsVisibility(!1),window.addEventListener("beforeunload",()=>{t._updateUiClient?.setButtonsVisibility&&t._updateUiClient.setButtonsVisibility({showButtons:!0})})),Spicetify.CosmosAsync.post("sp://messages/v1/container/control",{type:"update_titlebar",height:"1px"})};s(Spicetify.Platform.ControlMessageAPI),s(Spicetify.Platform.UpdateAPI);async function a(){s(Spicetify.Platform.ControlMessageAPI),s(Spicetify.Platform.UpdateAPI)}let n=setInterval(a,100);setTimeout(()=>{clearInterval(n)},1e4);let e=()=>{s(Spicetify.Platform.ControlMessageAPI),s(Spicetify.Platform.UpdateAPI)};document.addEventListener("fullscreenchange",e)}function B(s){let a=Math.floor(s/1e3),n=Math.floor(a/60);if(a=String(a%60).padStart(2,"0"),n<60)return`${n}:${a}`;let e=Math.floor(n/60);return n=String(n%60).padStart(2,"0"),`${e}:${n}:${a}`}function W(){if(!document.querySelector("#queue-panel")||document.querySelector("#wmpotify-queue-toolbar")||document.querySelectorAll('div[data-encore-id="tabPanel"]').length>2)return;let s=document.querySelector("#Desktop_PanelContainer_Id"),a=document.querySelector("#Desktop_PanelContainer_Id > div > div:first-child > div:first-child"),n=document.querySelector("#Desktop_PanelContainer_Id > div > div:nth-child(2)"),e=document.createElement("div");e.id="wmpotify-queue-toolbar";let t=document.createElement("button");t.id="wmpotify-queue-playlist-button",t.classList.add("wmpotify-toolbar-button"),t.addEventListener("click",()=>{window.open(Spicetify.Player.data.context.uri)}),t.textContent=document.querySelector('#queue-panel div[data-flip-id*="section-header-"] a')?.textContent||"Now Playing",t.innerHTML+='<span class="expandMark">\u23F7</span>',e.appendChild(t);let i=document.createElement("button");i.id="wmpotify-queue-clear-button",i.classList.add("wmpotify-toolbar-button"),i.addEventListener("click",()=>{Spicetify.Platform.PlayerAPI.clearQueue(),Spicetify.Player.playUri("")}),e.appendChild(i),n.insertAdjacentElement("afterbegin",e);let o=document.createElement("div");o.id="wmpotify-queue-npv";let r=document.createElement("img");r.id="wmpotify-queue-album-art",r.src=document.querySelector(".main-nowPlayingWidget-coverArt .cover-art img")?.src||"",o.appendChild(r);let u=document.createElement("div");u.id="wmpotify-queue-song-title",u.textContent=document.querySelector(".main-trackInfo-name")?.textContent||"",o.appendChild(u),a.insertAdjacentElement("afterbegin",o),E(),new MutationObserver(E).observe(document.querySelectorAll("#queue-panel ul")[1],{childList:!0}),new MutationObserver(()=>{E(),new MutationObserver(E).observe(document.querySelectorAll("#queue-panel ul")[1],{childList:!0})}).observe(document.querySelector("#queue-panel"),{childList:!0});let c=document.querySelectorAll('#Desktop_PanelContainer_Id div[role="tablist"] button'),f=[],d;for(let p of c)f.push({text:p.textContent,click:function(){for(let x of d.menuItems)x.classList.remove("activeStyle");this.classList.add("activeStyle"),p.click()}});f[0].classList=["activeStyle"],document.querySelector("#wmpotifyQueueTabMenuBg")?.remove(),d=q("wmpotifyQueueTab",f);let y=new S(["wmpotifyQueueTab"]);s.addEventListener("contextmenu",p=>{p.preventDefault(),y.openMenu("wmpotifyQueueTab",{left:p.clientX+"px",top:p.clientY+"px"})}),Spicetify.Player.addEventListener("songchange",()=>{t.textContent=Spicetify.Player.data?.context?.metadata?.context_description||"Now Playing",t.innerHTML+='<span class="expandMark">\u23F7</span>',r.src=Spicetify.Player.data?.item?.album?.images?.[0]?.url?.replace("spotify:image:","https://i.scdn.co/image/")||"",u.textContent=Spicetify.Player.data?.item?.name||""})}function E(){if(!document.querySelector("#queue-panel")||!Spicetify.Queue)return;let s=document.querySelectorAll("#queue-panel li .HeaderArea");for(let a=0;a<s.length;a++){let n=s[a];if(n.querySelector(".wmpotify-queue-duration"))continue;let e=a===0?Spicetify.Queue.track?.contextTrack?.metadata?.duration:Spicetify.Queue.nextTracks?.[a-1]?.contextTrack?.metadata?.duration;if(!e)continue;let t=document.createElement("span");t.classList.add("wmpotify-queue-duration"),t.textContent=B(e),n.appendChild(t)}}(function(){let s=[".Root__globalNav",".main-globalNav-historyButtons",".main-globalNav-searchSection",".main-globalNav-searchContainer > button",".main-globalNav-searchContainer > div form button",'.custom-navlinks-scrollable_container div[role="presentation"] > button',".main-topBar-topbarContentRight > .main-actionButtons > button",".main-topBar-topbarContentRight > button:last-child",".player-controls__left",'.player-controls__buttons button[data-testid="control-button-skip-back"]','.player-controls__buttons button[data-testid="control-button-repeat"]','.player-controls__buttons button[data-testid="control-button-playpause"]',".player-controls__right",".playback-bar .encore-text",".volume-bar",".volume-bar__icon-button",".volume-bar .progress-bar",".main-nowPlayingBar-left",".main-nowPlayingWidget-trackInfo",".Root__right-sidebar > div > div"],a={"Your Library":"Library","Friend Activity":"Friends"};async function n(){V(),localStorage.wmpotifyShowLibX||(document.body.dataset.hideLibx=!0);let t=document.querySelector(".Root__globalNav"),i=document.createElement("div");i.id="wmpotify-tabs-container",t.insertBefore(i,t.querySelector(".main-globalNav-searchSection"));let o=document.querySelector(".main-globalNav-searchContainer > button");I(o);let r=document.querySelector(".main-globalNav-searchContainer > div form button");I(r);let u=[o,r],c=document.querySelectorAll('.custom-navlinks-scrollable_container div[role="presentation"] > button');for(let l of c)I(l),u.push(l);let f=document.querySelectorAll(".main-topBar-topbarContentRight > .main-actionButtons > button");for(let l of f)I(l),u.push(l);let d=[];for(let l of u)d.push({text:l.querySelector(".wmpotify-tab-label").textContent,click:()=>l.click()});q("wmpotifyTab",d);let y=new S(["wmpotifyTab"]),p=document.createElement("button");p.id="wmpotify-tabs-overflow-button",p.addEventListener("click",()=>{y.openMenu("wmpotifyTab",{top:"0",left:p.getBoundingClientRect().left+"px"})}),i.appendChild(p),A(),window.addEventListener("resize",A);let x=document.querySelector(".main-topBar-topbarContentRight > button:last-child"),T=document.createElement("span");T.textContent=x.getAttribute("aria-label"),T.classList.add("wmpotify-user-label"),x.appendChild(T);let L=document.querySelector(".player-controls__buttons button[data-testid='control-button-playpause']");Spicetify.Player.addEventListener("onplaypause",_),new MutationObserver(_).observe(L,{attributes:!0,attributeFilter:["aria-label"]}),U(),new MutationObserver(U).observe(document.querySelector(".main-nowPlayingBar-left"),{childList:!0});let v=document.querySelector(".player-controls__left"),N=document.querySelector('.player-controls__buttons button[data-testid="control-button-skip-back"]'),R=document.querySelector('.player-controls__buttons button[data-testid="control-button-repeat"]');v.insertBefore(R,N);let w=document.createElement("button");w.setAttribute("aria-label","Stop"),w.id="wmpotify-stop-button",w.addEventListener("click",()=>{Spicetify.Platform.PlayerAPI.clearQueue(),Spicetify.Player.playUri("")}),v.insertBefore(w,N);let K=document.querySelector(".player-controls__right"),k=document.querySelector(".volume-bar"),C=k.querySelector(".volume-bar__icon-button"),Q=k.querySelector(".progress-bar");D(),new MutationObserver(D).observe(Q,{attributes:!0,attributeFilter:["style"]}),K.appendChild(k);let P=document.querySelectorAll(".playback-bar .encore-text"),g=document.createElement("span");g.classList.add("wmpotify-time-text");let M=parseInt(localStorage.wmpotifyTimeTextMode||0);M===2&&(g.style.left="-80px"),$(),g.addEventListener("click",()=>{M=(M+1)%3,localStorage.wmpotifyTimeTextMode=M,M===2?g.style.left="-80px":g.style.left=""}),v.insertAdjacentElement("afterbegin",g),Spicetify.Player.addEventListener("onprogress",$);let O=new MutationObserver(()=>{let l=v.children.length;l!==4&&(O.disconnect(),v.insertBefore(v.children[l-2],R),O.observe(v,{childList:!0}))});O.observe(v,{childList:!0}),W(),new MutationObserver(W).observe(document.querySelector(".Root__right-sidebar > div > div"),{childList:!0});function I(l){i.appendChild(l);let m=document.createElement("span"),h=l.getAttribute("aria-label");m.textContent=a[h]||h,m.classList.add("wmpotify-tab-label"),l.appendChild(m)}function A(){let l=document.querySelector(".main-globalNav-historyButtons").getBoundingClientRect().right,m=window.innerWidth-document.querySelector(".main-topBar-topbarContentRight").getBoundingClientRect().left,h=160,b=0;for(;window.innerWidth-l-m-h<i.getBoundingClientRect().width&&b<u.length;)u[u.length-1-b++].dataset.hidden=!0;for(b=document.querySelectorAll("#wmpotify-tabs-container button[data-hidden]").length;b>0&&window.innerWidth-l-m-h>i.getBoundingClientRect().width;)delete u[u.length-b--].dataset.hidden;p.style.display=b>0?"block":""}globalThis.handleTabOverflow=A;function U(){_();let l=document.querySelector(".main-nowPlayingWidget-trackInfo");if(!l||document.querySelector(".wmpotify-track-info"))return;let m=document.createElement("p");m.classList.add("wmpotify-track-info"),m.textContent=document.querySelector(".main-trackInfo-name")?.textContent||"",l.appendChild(m);let h=1;setInterval(()=>{if(!Spicetify.Player.isPlaying())return;let b=Spicetify.Player.data?.item.metadata;b&&(h===0?m.textContent=b.title:h===1?m.textContent=b.artist_name:h===2&&(m.textContent=b.album_title),h=(h+1)%3)},3e3),Spicetify.Player.addEventListener("songchange",()=>{h=0,m.textContent=Spicetify.Player.data?.item.metadata.title})}function _(){Spicetify.Player.isPlaying()?L.classList.add("playing"):L.classList.remove("playing")}function D(){let l=getComputedStyle(Q).getPropertyValue("--progress-bar-transform").replace("%","")/100;l===0?C.dataset.vol="muted":l<=.3?C.dataset.vol="low":l<=.6?C.dataset.vol="mid":C.dataset.vol="high"}function $(){switch(M){case 0:let l=Spicetify.Player.data.item.metadata.duration-Spicetify.Player.getProgress();g.textContent=B(l);break;case 1:g.textContent=P[0].textContent;break;case 2:g.textContent=`${P[0].textContent} / ${P[1].textContent}`;break}}}function e(){return window.Spicetify&&window.Spicetify.CosmosAsync&&window.Spicetify.Player?.origin?._state&&s.every(t=>document.querySelector(t))}window.addEventListener("load",()=>{let t=0,i=setInterval(()=>{if(e())n(),console.log("WMPotify: Theme loaded"),clearInterval(i);else if(t++>100){alert("[WMPotify] Theme loading failed. Please refresh the page to try again. Please make sure you have compatible Spoitfy version and have global navbar enabled."),clearInterval(i);let o=[];for(let r of s)document.querySelector(r)||o.push(r);console.log("WMPotify: Missing elements:",o)}},100)})})();})();
