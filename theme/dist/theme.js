(()=>{var C=class{constructor(i,o=[],e=[],s=[],r=[]){this.menuBar=i,this.menuOrder=o,this.submenus=e,this.openedMenu=null,this.mouseOverMenu=!1,this.mouseOverSubmenu=!1,this.handlingPointerEvent=!1,this.handlingKeyEvent=!1,this.boundMenuNavigationHandler=this.menuNavigationHandler.bind(this),this.submenuOpenTimer=null,this.submenuCloseTimer=null,this.shouldNotCloseSubmenu=!1,this.menuHierarchy={},this.beforeMenuOpenEvent=new Event("beforemenuopen"),this.afterMenuCloseEvent=new Event("aftermenuclose");for(let n of o){this.menuHierarchy[n]=[];let a=document.getElementById(n+"MenuBg"),u=a.querySelectorAll(".contextMenuItem");for(let t of u)t.dataset.submenu&&this.menuHierarchy[n].push(t.dataset.submenu),t.addEventListener("pointerover",()=>{for(let f of u)delete f.dataset.active;t.dataset.active=!0,clearTimeout(this.submenuOpenTimer),t.dataset.submenu?this.submenuOpenTimer=setTimeout(()=>{this.openMenu(t.dataset.submenu)},300):this.menuHierarchy[n].length>0&&this.delayedCloseMenu(this.menuHierarchy[n][0])}),t.addEventListener("pointerleave",()=>{this.mouseOverSubmenu||(delete t.dataset.active,clearTimeout(this.submenuOpenTimer),t.dataset.submenu&&this.delayedCloseMenu(t.dataset.submenu))}),t.addEventListener("click",()=>{t.dataset.submenu&&!t.classList.contains("disabled")?this.openedMenu.id!==t.dataset.submenu+"MenuBg"?this.openMenu(t.dataset.submenu):document.getElementById(t.dataset.submenu+"MenuBg").focus():t.dataset.noClose||this.closeMenu(n)});a.addEventListener("focusout",t=>{top.ignoreFocusLoss||t.relatedTarget&&t.relatedTarget.dataset.submenuOf===n||this.closeMenu(n)}),a.addEventListener("pointermove",t=>{(t.clientX>0||t.clientY>0)&&(a.style.animation="none")})}for(let n of e){let a=document.getElementById(n+"MenuBg"),u=a.querySelectorAll(".contextMenuItem"),t=document.getElementById(a.dataset.submenuOf+"MenuBg"),f=Array.from(t.querySelectorAll(".contextMenuItem")).findIndex(c=>c.dataset.submenu===n),m=t.querySelectorAll(".contextMenuItem")[f];for(let c of u)c.addEventListener("pointerover",()=>{for(let g of u)delete g.dataset.active;c.dataset.active=!0}),c.addEventListener("pointerleave",()=>{delete c.dataset.active}),c.addEventListener("click",()=>{this.shouldNotCloseSubmenu=!1,this.closeMenu(n),this.closeMenu(a.dataset.submenuOf)});a.addEventListener("pointerover",()=>{this.mouseOverMenu=!0,this.mouseOverSubmenu=!0,this.shouldNotCloseSubmenu=!0,clearTimeout(this.submenuCloseTimer),m.dataset.active=!0}),a.addEventListener("pointerleave",()=>{this.mouseOverMenu=!1,this.mouseOverSubmenu=!1,this.shouldNotCloseSubmenu=!1}),a.addEventListener("focusout",c=>{if(top.ignoreFocusLoss||a.style.display==="none")return;this.shouldNotCloseSubmenu=!1;let g=!!a.dataset.openStandalone;c.relatedTarget&&c.relatedTarget.id&&c.relatedTarget.id===t.id||(this.closeMenu(n),!(c.relatedTarget&&c.relatedTarget.id&&c.relatedTarget.dataset.submenuOf===a.dataset.submenuOf)&&(g||this.closeMenu(a.dataset.submenuOf)))})}for(let n of s){let a=document.getElementById(n+"MenuBg"),u=a.querySelectorAll(".contextMenuItem");a.addEventListener("focusout",()=>{top.ignoreFocusLoss||this.closeMenu(n)});for(let t of u)t.addEventListener("pointerover",()=>{for(let f of u)delete f.dataset.active;t.dataset.active=!0}),t.addEventListener("pointerleave",()=>{delete t.dataset.active}),t.addEventListener("pointerdown",f=>{f.preventDefault()}),t.addEventListener("click",()=>{t.addEventListener("click",()=>{t.dataset.submenu&&!t.classList.contains("disabled")?this.openedMenu.id!==t.dataset.submenu+"MenuBg"?this.openMenu(t.dataset.submenu):document.getElementById(t.dataset.submenu+"MenuBg").focus():t.dataset.noClose||this.closeMenu(n)})})}}openMenu(i,o){let e=document.getElementById(i+"MenuBg"),s=document.getElementById(i+"Menu"),r=!!e.dataset.submenuOf,n,a,u,t=e.querySelectorAll(".contextMenuItem.debug");if(localStorage.wmpotifyDebugMode){u=e.querySelectorAll(".contextMenuItem:not([data-hidden])");for(let m of t)m.style.display=""}else{u=e.querySelectorAll(".contextMenuItem:not([data-hidden]):not(.debug)");for(let m of t)m.style.display="none"}if(e.dispatchEvent(this.beforeMenuOpenEvent),o)e.dataset.openStandalone=!0;else{if(r){if(this.menuHierarchy[e.dataset.submenuOf].length>1)for(let c of this.menuHierarchy[e.dataset.submenuOf])c!==i&&this.closeMenu(c);if(n=document.getElementById(e.dataset.submenuOf+"MenuBg"),n.style.display==="none")return;let m=Array.from(n.querySelectorAll(".contextMenuItem")).findIndex(c=>c.dataset.submenu===i);if(a=n.querySelectorAll(".contextMenuItem")[m],a.classList.contains("disabled"))return}else for(let m of this.menuOrder)m!==i&&document.getElementById(m+"MenuBg").style.display==="block"&&this.closeMenu(m);delete e.dataset.openStandalone}e.style.animation="";for(let m of u)delete m.dataset.active;if(o)e.style.top=o.y+"px",e.style.left=o.x+"px";else{let m="",c=0;r&&(m=n.offsetTop+a.offsetTop,c=n.offsetLeft+n.offsetWidth-6),e.style.top=m+"px",e.style.left=c+"px"}e.style.display="block";let f=this.calcMenuWidth(i);e.style.width=f+")",e.style.minWidth=0,s.style.width=f+" - 2px)",e.style.height=this.calcMenuHeight(i)+"px",o||r&&(a.dataset.active=!0),e.focus(),this.openedMenu=e,document.addEventListener("keydown",this.boundMenuNavigationHandler)}closeMenu(i){let o=document.getElementById(i+"MenuBg"),e=!!o.dataset.openStandalone,s=!!o.dataset.submenuOf&&!e;if(s&&this.shouldNotCloseSubmenu)return;let r,n;if(!e&&s){r=document.getElementById(o.dataset.submenuOf+"MenuBg");let a=Array.from(r.querySelectorAll(".contextMenuItem")).findIndex(u=>u.dataset.submenu===i);n=r.querySelectorAll(".contextMenuItem")[a]}this.submenuCloseTimer&&clearTimeout(this.submenuCloseTimer),o.style.display="none",e?delete o.dataset.openStandalone:s&&delete n.dataset.active,this.mouseOverMenu,o.dispatchEvent(this.afterMenuCloseEvent),s&&r.style.display!=="none"?(r.focus(),this.openedMenu=r):(this.openedMenu=null,document.removeEventListener("keydown",this.boundMenuNavigationHandler))}delayedCloseMenu(i){this.submenuCloseTimer=setTimeout(()=>{this.closeMenu(i)},300)}menuNavigationHandler(i){if(!this.openedMenu)return;let o;localStorage.wmpotifyDebugMode?o=this.openedMenu.querySelectorAll(".contextMenuItem"):o=this.openedMenu.querySelectorAll(".contextMenuItem:not(.debug)");let e=this.openedMenu.querySelector(".contextMenuItem[data-active]"),s=Array.from(o).indexOf(e),r;switch(this.openedMenu.dataset.submenuOf&&(r=document.getElementById(this.openedMenu.dataset.submenuOf+"MenuBg").querySelector(".contextMenuItem[data-active]")),this.handlingKeyEvent=!0,this.openedMenu.style.animation="none",i.key){case"Escape":this.mouseOverMenu=!1,this.openedMenu.blur();break;case"ArrowUp":e?(delete e.dataset.active,s>0?o[s-1].dataset.active=!0:o[o.length-1].dataset.active=!0):o[o.length-1].dataset.active=!0;break;case"ArrowDown":e?(delete e.dataset.active,s<o.length-1?o[s+1].dataset.active=!0:o[0].dataset.active=!0):o[0].dataset.active=!0;break;case"ArrowLeft":if(this.openedMenu.dataset.submenuOf){this.closeMenu(this.openedMenu.id.slice(0,-6),!0),r.dataset.active=!0;break}if(this.menuOrder.length===1)break;let n=this.menuOrder[(this.menuOrder.indexOf(this.openedMenu.id.slice(0,-6))+this.menuOrder.length-1)%this.menuOrder.length];this.closeMenu(this.openedMenu.id.slice(0,-6)),this.openMenu(n),this.openedMenu.querySelector(".contextMenuItem").dataset.active=!0;break;case"ArrowRight":if(e&&e.dataset.submenu){this.openMenu(e.dataset.submenu),this.openedMenu.querySelector(".contextMenuItem").dataset.active=!0;break}if(this.menuOrder.length===1)break;let a;this.openedMenu.dataset.submenuOf?(a=this.menuOrder[(this.menuOrder.indexOf(this.openedMenu.dataset.submenuOf)+1)%this.menuOrder.length],this.closeMenu(this.openedMenu.id.slice(0,-6))):(a=this.menuOrder[(this.menuOrder.indexOf(this.openedMenu.id.slice(0,-6))+1)%this.menuOrder.length],this.closeMenu(this.openedMenu.id.slice(0,-6))),this.openMenu(a),this.openedMenu.querySelector(".contextMenuItem").dataset.active=!0;break;case"Enter":if(e)e.click();else{this.openedMenu.blur();break}break;default:let u=this.openedMenu.getElementsByTagName("u");for(let t of u)if(i.key===t.textContent.toLowerCase()){t.parentElement.click();break}}this.handlingKeyEvent=!1,i.preventDefault(),i.stopPropagation()}calcMenuWidth(i){let o=document.getElementById(i+"MenuBg"),e;localStorage.wmpotifyDebugMode?e=o.querySelectorAll(".contextMenuItem:not([data-hidden])"):e=o.querySelectorAll(".contextMenuItem:not([data-hidden]):not(.debug)"),o.style.minWidth="";let s=parseInt(getComputedStyle(o).minWidth)||0;return`calc(${Array.from(e).reduce((n,a)=>{let u=a.textContent,t=k(u);return Math.max(s,n,t)},0)}px + 4.5em`}calcMenuHeight(i){let o=document.getElementById(i+"MenuBg"),e=o.querySelectorAll("hr"),s;localStorage.wmpotifyDebugMode?s=o.querySelectorAll(".contextMenuItem:not([data-hidden])"):s=o.querySelectorAll(".contextMenuItem:not([data-hidden]):not(.debug)");let r=s[0].offsetHeight,n=0;if(e.length>0){let u=getComputedStyle(e[0]);n=e[0].offsetHeight+parseFloat(u.marginTop)+parseFloat(u.marginBottom)}return parseInt(s.length*r+e.length*n)}};function P(l,i,o){let e=document.createElement("div");e.id=l+"MenuBg",e.className="contextMenuBg",e.tabIndex=-1,e.style.display="none",e.innerHTML=`<div id="${l}Menu" class="contextMenu"></div>`,o&&(e.dataset.submenuOf=o),i.forEach(s=>{if(s.hr){let n=document.createElement("hr");e.querySelector(".contextMenu").appendChild(n);return}let r=document.createElement("div");r.className="contextMenuItem",s.args?r.innerHTML="<p>"+R(s.text,...s.args)+"</p>":r.innerHTML="<p>"+R(s.text)+"</p>",s.disabled&&r.classList.add("disabled"),s.hidden&&(r.dataset.hidden=!0),s.submenu&&(r.dataset.submenu=s.submenu,r.innerHTML+='<p class="submenuMark">\u23F5</p>'),s.noClose&&(r.dataset.noClose=!0),r.addEventListener("click",s.click),e.querySelector(".contextMenu").appendChild(r)}),document.body.appendChild(e)}function k(l,i=getComputedStyle(document.documentElement).getPropertyValue("--menu-font")){let e=(k.canvas||(k.canvas=document.createElement("canvas"))).getContext("2d");return e.font=i,e.measureText(l).width}function R(l){if(l=l.replace(/&([^&])/g,"<u>$1</u>").replace(/\\&/g,"&"),arguments.length>1)for(let i=1;i<arguments.length;i++)l=l.replace(/%s/,arguments[i]),l=l.replace(`%${i}s`,arguments[i]);return l}function U(){let l=s=>{s&&(s._updateUiClient?.updateTitlebarHeight&&s._updateUiClient.updateTitlebarHeight({height:1}),s._updateUiClient?.setButtonsVisibility&&s._updateUiClient.setButtonsVisibility(!1),window.addEventListener("beforeunload",()=>{s._updateUiClient?.setButtonsVisibility&&s._updateUiClient.setButtonsVisibility({showButtons:!0})})),Spicetify.CosmosAsync.post("sp://messages/v1/container/control",{type:"update_titlebar",height:"1px"})};l(Spicetify.Platform.ControlMessageAPI),l(Spicetify.Platform.UpdateAPI);async function i(){l(Spicetify.Platform.ControlMessageAPI),l(Spicetify.Platform.UpdateAPI)}let o=setInterval(i,100);setTimeout(()=>{clearInterval(o)},1e4);let e=()=>{l(Spicetify.Platform.ControlMessageAPI),l(Spicetify.Platform.UpdateAPI)};document.addEventListener("fullscreenchange",e)}function T(){if(!document.querySelector("#queue-panel")||document.querySelector("#wmpotify-queue-toolbar")||document.querySelectorAll('div[data-encore-id="tabPanel"]').length>2)return;let l=document.querySelector("#Desktop_PanelContainer_Id > div > div:first-child > div:first-child"),i=document.querySelector("#Desktop_PanelContainer_Id > div > div:nth-child(2)"),o=document.createElement("div");o.id="wmpotify-queue-toolbar";let e=document.createElement("button");e.id="wmpotify-queue-playlist-button",e.classList.add("wmpotify-toolbar-button"),e.addEventListener("click",()=>{window.open(Spicetify.Player.data.context.uri)}),e.textContent=document.querySelector('#queue-panel div[data-flip-id*="section-header-"] a')?.textContent||"Now Playing",e.innerHTML+='<span class="expandMark">\u23F7</span>',o.appendChild(e);let s=document.createElement("button");s.id="wmpotify-queue-clear-button",s.classList.add("wmpotify-toolbar-button"),s.addEventListener("click",()=>{Spicetify.Platform.PlayerAPI.clearQueue(),Spicetify.Player.playUri("")}),o.appendChild(s),i.insertAdjacentElement("afterbegin",o);let r=document.createElement("div");r.id="wmpotify-queue-npv";let n=document.createElement("img");n.id="wmpotify-queue-album-art",n.src=document.querySelector(".main-nowPlayingWidget-coverArt .cover-art img")?.src||"",r.appendChild(n);let a=document.createElement("div");a.id="wmpotify-queue-song-title",a.textContent=document.querySelector(".main-trackInfo-name")?.textContent||"",r.appendChild(a),l.insertAdjacentElement("afterbegin",r),Spicetify.Player.addEventListener("songchange",()=>{e.textContent=Spicetify.Player.data?.context?.metadata?.context_description||"Now Playing",e.innerHTML+='<span class="expandMark">\u23F7</span>',n.src=Spicetify.Player.data?.item?.album?.images?.[0]?.url?.replace("spotify:image:","https://i.scdn.co/image/")||"",a.textContent=Spicetify.Player.data?.item?.name||""})}(function(){let l=[".Root__globalNav",".main-globalNav-searchContainer > button",".main-globalNav-searchContainer > div form button",'.custom-navlinks-scrollable_container div[role="presentation"] > button',".main-topBar-topbarContentRight > .main-actionButtons > button",".main-topBar-topbarContentRight > button:last-child",".player-controls__left",'.player-controls__buttons button[data-testid="control-button-skip-back"]','.player-controls__buttons button[data-testid="control-button-repeat"]','.player-controls__buttons button[data-testid="control-button-playpause"]',".player-controls__right",".playback-bar .encore-text",".volume-bar",".volume-bar__icon-button",".volume-bar .progress-bar",".main-nowPlayingBar-left",".main-nowPlayingWidget-trackInfo",".Root__right-sidebar > div > div"],i={"Your Library":"Library","Friend Activity":"Friends"};async function o(){U(),localStorage.wmpotifyShowLibX||(document.body.dataset.hideLibx=!0);let n=document.querySelector(".Root__globalNav"),a=document.createElement("div");a.classList.add("wmpotify-tabs-container"),n.insertBefore(a,n.querySelector(".main-globalNav-searchSection"));let u=document.querySelector(".main-globalNav-searchContainer > button");x(u);let t=document.querySelector(".main-globalNav-searchContainer > div form button");x(t);let f=document.querySelectorAll('.custom-navlinks-scrollable_container div[role="presentation"] > button');for(let d of f)x(d);let m=document.querySelectorAll(".main-topBar-topbarContentRight > .main-actionButtons > button");for(let d of m)x(d);let c=document.querySelector(".main-topBar-topbarContentRight > button:last-child"),g=document.createElement("span");g.textContent=c.getAttribute("aria-label"),g.classList.add("wmpotify-user-label"),c.appendChild(g);let E=document.querySelector(".player-controls__buttons button[data-testid='control-button-playpause']");Spicetify.Player.addEventListener("onplaypause",q),new MutationObserver(q).observe(E,{attributes:!0,attributeFilter:["aria-label"]}),H(),new MutationObserver(H).observe(document.querySelector(".main-nowPlayingBar-left"),{childList:!0});let b=document.querySelector(".player-controls__left"),O=document.querySelector('.player-controls__buttons button[data-testid="control-button-skip-back"]'),_=document.querySelector('.player-controls__buttons button[data-testid="control-button-repeat"]');b.insertBefore(_,O);let M=document.createElement("button");M.setAttribute("aria-label","Stop"),M.classList.add("wmpotify-stop-button"),M.addEventListener("click",()=>{Spicetify.Platform.PlayerAPI.clearQueue(),Spicetify.Player.playUri("")}),b.insertBefore(M,O);let F=document.querySelector(".player-controls__right"),B=document.querySelector(".volume-bar"),S=B.querySelector(".volume-bar__icon-button"),A=B.querySelector(".progress-bar");N(),new MutationObserver(N).observe(A,{attributes:!0,attributeFilter:["style"]}),F.appendChild(B);let w=document.querySelectorAll(".playback-bar .encore-text"),h=document.createElement("span");h.classList.add("wmpotify-time-text");let v=parseInt(localStorage.wmpotifyTimeTextMode||0);v===2&&(h.style.left="-80px"),W(),h.addEventListener("click",()=>{v=(v+1)%3,localStorage.wmpotifyTimeTextMode=v,v===2?h.style.left="-80px":h.style.left=""}),b.insertAdjacentElement("afterbegin",h),Spicetify.Player.addEventListener("onprogress",W);let L=new MutationObserver(()=>{let d=b.children.length;d!==4&&(L.disconnect(),b.insertBefore(b.children[d-2],_),L.observe(b,{childList:!0}))});L.observe(b,{childList:!0}),T(),new MutationObserver(T).observe(document.querySelector(".Root__right-sidebar > div > div"),{childList:!0});function x(d){a.appendChild(d);let p=document.createElement("span"),y=d.getAttribute("aria-label");p.textContent=i[y]||y,p.classList.add("wmpotify-tab-label"),d.appendChild(p)}function H(){q();let d=document.querySelector(".main-nowPlayingWidget-trackInfo");if(!d||document.querySelector(".wmpotify-track-info"))return;let p=document.createElement("p");p.classList.add("wmpotify-track-info"),p.textContent=document.querySelector(".main-trackInfo-name")?.textContent||"",d.appendChild(p);let y=1;setInterval(()=>{if(!Spicetify.Player.isPlaying())return;let I=Spicetify.Player.data?.item.metadata;I&&(y===0?p.textContent=I.title:y===1?p.textContent=I.artist_name:y===2&&(p.textContent=I.album_title),y=(y+1)%3)},3e3),Spicetify.Player.addEventListener("songchange",()=>{y=0,p.textContent=Spicetify.Player.data?.item.metadata.title})}function q(){Spicetify.Player.isPlaying()?E.classList.add("playing"):E.classList.remove("playing")}function N(){let d=getComputedStyle(A).getPropertyValue("--progress-bar-transform").replace("%","")/100;d===0?S.dataset.vol="muted":d<=.3?S.dataset.vol="low":d<=.6?S.dataset.vol="mid":S.dataset.vol="high"}function W(){switch(v){case 0:let d=Spicetify.Player.data.item.metadata.duration-Spicetify.Player.getProgress();h.textContent=e(d);break;case 1:h.textContent=w[0].textContent;break;case 2:h.textContent=`${w[0].textContent} / ${w[1].textContent}`;break}}}function e(n){let a=Math.floor(n/1e3),u=Math.floor(a/60);if(a=String(a%60).padStart(2,"0"),u<60)return`${u}:${a}`;let t=Math.floor(u/60);return u=String(u%60).padStart(2,"0"),`${t}:${u}:${a}`}function s(){return window.Spicetify&&window.Spicetify.CosmosAsync&&window.Spicetify.Player?.origin?._state&&l.every(n=>document.querySelector(n))}window.addEventListener("load",()=>{let n=0,a=setInterval(()=>{if(s())o(),console.log("WMPotify: Theme loaded"),clearInterval(a);else if(n++>100){alert("[WMPotify] Theme loading failed. Please refresh the page to try again. Please make sure you have compatible Spoitfy version and have global navbar enabled."),clearInterval(a);let u=[];for(let t of l)document.querySelector(t)||u.push(t);console.log("WMPotify: Missing elements:",u)}},100)}),P("test",[{text:"&Item 1",click:()=>console.log("Item 1 clicked")},{text:"I&tem 2",click:()=>console.log("Item 2 clicked")},{text:"&Submenu",submenu:"testsub"}]),P("testsub",[{text:"Sub&item 1",click:()=>console.log("Subitem 1 clicked")},{text:"Subi&tem 2",click:()=>console.log("Subitem 2 clicked")}],"test");let r=new C(document.createElement("div"),["test"],["testsub"],[],[]);r.openMenu("test",{x:300,y:100}),globalThis.menu=r,window.ignoreFocusLoss=!0})();})();
