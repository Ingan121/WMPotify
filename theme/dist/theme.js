(()=>{function O(){let s=a=>{a&&(a._updateUiClient?.updateTitlebarHeight&&a._updateUiClient.updateTitlebarHeight({height:1}),a._updateUiClient?.setButtonsVisibility&&a._updateUiClient.setButtonsVisibility(!1),window.addEventListener("beforeunload",()=>{a._updateUiClient?.setButtonsVisibility&&a._updateUiClient.setButtonsVisibility({showButtons:!0})})),Spicetify.CosmosAsync.post("sp://messages/v1/container/control",{type:"update_titlebar",height:"1px"})};s(Spicetify.Platform.ControlMessageAPI),s(Spicetify.Platform.UpdateAPI);async function h(){s(Spicetify.Platform.ControlMessageAPI),s(Spicetify.Platform.UpdateAPI)}let y=setInterval(h,100);setTimeout(()=>{clearInterval(y)},1e4);let b=()=>{s(Spicetify.Platform.ControlMessageAPI),s(Spicetify.Platform.UpdateAPI)};document.addEventListener("fullscreenchange",b)}(function(){let s=[".Root__globalNav",".main-globalNav-searchContainer > button",".main-globalNav-searchContainer > div form button",'.custom-navlinks-scrollable_container div[role="presentation"] > button',".main-topBar-topbarContentRight > .main-actionButtons > button",".main-topBar-topbarContentRight > button:last-child",".player-controls__left",'.player-controls__buttons button[data-testid="control-button-skip-back"]','.player-controls__buttons button[data-testid="control-button-repeat"]','.player-controls__buttons button[data-testid="control-button-playpause"]',".player-controls__right",".playback-bar .encore-text",".volume-bar"],h={"Your Library":"Library","Friend Activity":"Friends"};async function y(){O(),localStorage.wmpotifyShowLibX||(document.body.dataset.hideLibx=!0);let u=document.querySelector(".Root__globalNav"),t=document.createElement("div");t.classList.add("wmpotify-tabs-container"),u.insertBefore(t,u.querySelector(".main-globalNav-searchSection"));let n=document.querySelector(".main-globalNav-searchContainer > button");f(n);let c=document.querySelector(".main-globalNav-searchContainer > div form button");f(c);let T=document.querySelectorAll('.custom-navlinks-scrollable_container div[role="presentation"] > button');for(let e of T)f(e);let k=document.querySelectorAll(".main-topBar-topbarContentRight > .main-actionButtons > button");for(let e of k)f(e);let I=document.querySelector(".main-topBar-topbarContentRight > button:last-child"),g=document.createElement("span");g.textContent=I.getAttribute("aria-label"),g.classList.add("wmpotify-user-label"),I.appendChild(g);let M=document.querySelector(".player-controls__buttons button[data-testid='control-button-playpause']");Spicetify.Player.addEventListener("onplaypause",x),new MutationObserver(x).observe(M,{attributes:!0,attributeFilter:["aria-label"]}),E(),new MutationObserver(E).observe(document.querySelector(".main-nowPlayingBar-left"),{childList:!0});let l=document.querySelector(".player-controls__left"),C=document.querySelector('.player-controls__buttons button[data-testid="control-button-skip-back"]'),B=document.querySelector('.player-controls__buttons button[data-testid="control-button-repeat"]');l.insertBefore(B,C);let m=document.createElement("button");m.setAttribute("aria-label","Stop"),m.classList.add("wmpotify-stop-button"),m.addEventListener("click",()=>{Spicetify.Platform.PlayerAPI.clearQueue(),Spicetify.Player.playUri("")}),l.insertBefore(m,C);let w=document.querySelector(".player-controls__right"),q=document.querySelector(".volume-bar");w.appendChild(q);let v=document.querySelectorAll(".playback-bar .encore-text"),i=document.createElement("span");i.classList.add("wmpotify-time-text");let d=parseInt(localStorage.wmpotifyTimeTextMode||0);d===2&&(i.style.left="-80px"),L(),i.addEventListener("click",()=>{d=(d+1)%3,localStorage.wmpotifyTimeTextMode=d,d===2?i.style.left="-80px":i.style.left=""}),l.insertAdjacentElement("afterbegin",i),Spicetify.Player.addEventListener("onprogress",L);let S=new MutationObserver(()=>{let e=l.children.length;e!==4&&(S.disconnect(),l.insertBefore(l.children[e-2],B),S.observe(l,{childList:!0}))});S.observe(l,{childList:!0});function f(e){t.appendChild(e);let o=document.createElement("span"),r=e.getAttribute("aria-label");o.textContent=h[r]||r,o.classList.add("wmpotify-tab-label"),e.appendChild(o)}function E(){x();let e=document.querySelector(".main-nowPlayingWidget-trackInfo");if(!e||document.querySelector(".wmpotify-track-info"))return;let o=document.createElement("p");o.classList.add("wmpotify-track-info"),o.textContent=document.querySelector(".main-trackInfo-name")?.textContent||"",e.appendChild(o);let r=1;setInterval(()=>{if(!Spicetify.Player.isPlaying())return;let p=Spicetify.Player.data?.item.metadata;p&&(r===0?o.textContent=p.title:r===1?o.textContent=p.artist_name:r===2&&(o.textContent=p.album_title),r=(r+1)%3)},3e3),Spicetify.Player.addEventListener("songchange",()=>{r=0,o.textContent=Spicetify.Player.data?.item.metadata.title})}function x(){Spicetify.Player.isPlaying()?M.classList.add("playing"):M.classList.remove("playing")}function L(){switch(d){case 0:let e=Spicetify.Player.data.item.metadata.duration-Spicetify.Player.getProgress();i.textContent=b(e);break;case 1:i.textContent=v[0].textContent;break;case 2:i.textContent=`${v[0].textContent} / ${v[1].textContent}`;break}}}function b(u){let t=Math.floor(u/1e3),n=Math.floor(t/60);if(t=String(t%60).padStart(2,"0"),n<60)return`${n}:${t}`;let c=Math.floor(n/60);return n=String(n%60).padStart(2,"0"),`${c}:${n}:${t}`}function a(){return window.Spicetify&&window.Spicetify.CosmosAsync&&window.Spicetify.Player?.origin?._state&&s.every(u=>document.querySelector(u))}window.addEventListener("load",()=>{let u=0,t=setInterval(()=>{if(a())y(),console.log("WMPotify: Theme loaded"),clearInterval(t);else if(u++>100){alert("[WMPotify] Theme loading failed. Please refresh the page to try again. Please make sure you have compatible Spoitfy version and have global navbar enabled."),clearInterval(t);let n=[];for(let c of s)document.querySelector(c)||n.push(c);console.log("WMPotify: Missing elements:",n)}},100)})})();})();
